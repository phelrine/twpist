roman={
        "あ": "a"         , "い": ["i", "yi"], "う": ["u", "wu", "whu"], "え": "e", "お": "o",
        "か": ["ka", "ca"], "き": "ki", "く": ["ku", "cu", "qu"], "け": "ke", "こ": ["ko", "co"],
        "さ": "sa"        , "し": ["si", "shi", "ci"], "す": "su", "せ": ["se", "ce"], "そ": "so",
        "た": "ta"        , "ち": ["ti", "chi"], "つ": ["tu", "tsu"], "て": "te", "と": "to"
        "な": "na"        , "に": "ni", "ぬ": "nu", "ね": "ne", "の": "no",
        "は": "ha"        , "ひ": "hi", "ふ": ["hu", "fu"], "へ": "he", "ほ": "ho",
        "ま": "ma"        , "み": "mi", "む": "mu", "め": "me", "も": "mo",
        "や": "ya"        , "ゆ": "yu", "いぇ": "ye", "よ": "yo",
        "ら": "ra"        , "り": "ri", "る": "ru", "れ": "re", "ろ": "ro",
        "わ": "wa"        , "を": "wo",
        "ん": ["nn", "n"] ,
        "が": "ga"        , "ぎ": "gi", "ぐ": "gu", "げ": "ge", "ご": "go",
        "ざ": "za"        , "じ": ["zi", "ji"], "ず": "zu", "ぜ": "ze", "ぞ": "zo",
        "だ": "da"        , "ぢ": "di", "づ": "du", "で": "de", "ど": "do",
        "ば": "ba"        , "び": "bi", "ぶ": "bu", "べ": "be", "ぼ": "bo",
        "ぱ": "pa"        , "ぴ": "pi", "ぷ": "pu", "ぺ": "pe", "ぽ": "po",
        "きゃ": "kya"     , "きぃ": "kyi", "きゅ": "kyu", "きぇ": "kye", "きょ": "kyo",
        "しゃ": ["sya", "sha"], "しぃ": "syi", "しゅ": ["syu", "shu"], "しぇ": ["sye", "she"], "しょ": ["syo", "sho"],
        "ちゃ": ["tya","cya","cha"], "ちぃ": ["tyi","cyi"], "ちゅ": ["tyu","cyu","chu"], "ちぇ": ["tye","cye","che"], "ちょ": ["tyo", "cyo", "cho"],
        "にゃ": "nya", "にぃ": "nyi", "にゅ": "nyu", "にぇ": "nye", "にょ": "nyo",
        "ひゃ": "hya", "ひぃ": "hyi", "ひゅ": "hyu", "ひぇ": "hye", "ひょ": "hyo",
        "みゃ": "mya", "みぃ": "myi", "みゅ": "myu", "みぇ": "mye", "みょ": "myo",
        "りゃ": "rya", "りぃ": "ryi", "りゅ": "ryu", "りぇ": "rye", "りょ": "ryo",
        "ぎゃ": "gya", "ぎぃ": "gyi", "ぎゅ": "gyu", "ぎぇ": "gye", "ぎょ": "gyo",
        "じゃ": ["zya","ja","jya"], "じぃ": ["zyi","jyi"], "じゅ": ["zyu","ju","jyu"], "じぇ": ["zye","je","jye"], "じょ": ["zyo","jo","jyo"],
        "ぢゃ": "dya", "ぢぃ": "dyi", "ぢゅ": "dyu", "ぢぇ": "dye", "ぢょ": "dyo",
        "びゃ": "bya", "びぃ": "byi", "びゅ": "byu", "びぇ": "bye", "びょ": "byo",
        "ぴゃ": "pya", "ぴぃ": "pyi", "ぴゅ": "pyu", "ぴぇ": "pye", "ぴょ": "pyo"
        "ぁ": ["la", "xa"], "ぃ": ["li", "xi", "lyi", "xyi"], "ぅ": ["lu", "xu"], "ぇ": ["le", "xe", "lye", "xye"], "ぉ": ["lo", "xo"],
        "ゃ": ["lya", "xya"], "ゅ": ["lyu", "xyu"], "ょ": ["lyo", "xyo"],
        "ゎ": ["lwa", "xwa"],
        "っ": ["ltu", "ltsu", "xtu"],
        "ぐぁ": "gwa", "ぐぃ": "gwi", "ぐぅ": "gwu", "ぐぇ": "gwe", "ぐぉ": "gwo",
        "でゃ": "dha", "でぃ": "dhi", "でゅ": "dhu", "でぇ": "dhe", "でょ": "dho",
        "どぁ": "dwa", "どぃ": "dwi", "どぅ": "dwu", "どぇ": "dwe", "どぉ": "dwo",
        "ヴぁ": "va", "ヴぃ": ["vi", "vyi"], "ヴ": "vu", "ヴぇ": ["ve", "vye"], "ヴぉ": "vo",
        "ヴゃ": "vya", "ヴゅ": "vyu", "ヴょ": "vyo",
        "うぁ": "wha", "うぃ": ["wi", "whi"], "うぇ": ["we", "whe"], "うぉ": "who",
        "くぁ": ["qa", "qwa", "kwa"], "くぃ": ["qi", "qwi", "qyi"], "くぅ": "qwu", "くぇ": ["qe", "qwe", "qye"], "くぉ": ["qo", "qwo"],
        "くゃ": "qya", "くゅ": "qyu", "くょ": "qyo",
        "すぁ": "swa", "すぃ": "swi", "すぅ": "swu", "すぇ": "swe", "すぉ": "swo",
        "つぁ": "tsa", "つぃ": "tsi", "つぇ": "tse", "つぉ": "tso",
        "てゃ": "tha", "てぃ": "thi", "てゅ": "thu", "てぇ": "the", "てょ": "tho",
        "とぁ": "twa", "とぃ": "twi", "とぅ": "twu", "とぇ": "twe", "とぉ": "two",
        "ふぁ": ["fa", "fwa"], "ふぃ": ["fi", "fwi", "fyi"], "ふぅ": "fwu", "ふぇ": ["fe", "fwe", "fye"], "ふぉ": ["fo", "fwo"],
        "ふゃ": "fya", "ふゅ": "fyu", "ふょ": "fyo",
        "ー": "-"
        }

array = 0
pos = 0
inputed = ""

prepareTyping = (sentence)->
        document.getElementById('sentence').innerHTML = sentence

        key = 1
        array=[]

        for i in sentence
                temp=[]

                if i is "ん"
                        if sentence[key]?
                                r = roman[sentence[key]]
                                try
                                        r.push()
                                catch error
                                        r=[r]
                                for j in r
                                        if j[0] is "n"
                                                temp.push(["n", "n", key])
                                        else
                                                temp.push(["n", "n", key])
                                                temp.push(["n", key])
                        else
                                temp.push(["n", "n", key])

                else
                        if i is "っ" and sentence[key] isnt "ん" and sentence[key]?
                                if sentence[key+1]?
                                        r = roman[sentence[key]+sentence[key+1]]
                                        if r?
                                                try
                                                        r.push()
                                                catch error
                                                        r=[r]
                                                for j in r
                                                        s = j[0]+j
                                                        s = s.split('')
                                                        s.push(key+2)
                                                        temp.push(s)
                                r = roman[sentence[key]]
                                try
                                        r.push()
                                catch error
                                        r=[r]
                                for j in r
                                        s = j[0]+j
                                        s = s.split('')
                                        s.push(key+1)
                                        temp.push(s)


                        r = roman[i+sentence[key]]
                        if r?
                                try
                                        r.push()
                                catch error
                                        r=[r]
                                for j in r
                                        s = j.split('')
                                        s.push(key+1)
                                        temp.push(s)

                        r = roman[i]
                        try
                                r.push()
                        catch error
                                r=[r]
                        for j in r
                                s = j.split('')
                                s.push(key)
                                temp.push(s)

                array.push(temp)
                key += 1
        return array

displaytype = ->
        count = 0
        t = ""
        while array[count]?
                i = 0
                j = 0
                while array[count][j]?
                        if array[count][j][0] isnt null
                                while i < array[count][j].length-1
                                        t += array[count][j][i]
                                        i += 1
                                count=array[count][j][array[count][j].length-1]
                                break
                        j += 1
        return t

checkType = (key) ->

        if array[pos-1]?
                if array[pos-1][0][0] is "n" and array[pos-1][0].length is 2 and array[pos-1][1].length is 1
                        if key isnt "n"
                                array[pos-1][0].unshift(null)
                        else
                                pos = pos-1



        flag = 0
        for i in array[pos]
                if key is i[0]
                        flag = 1
        if flag is 1
                document.getElementById('input').style.color = "black"
                i = 0
                while array[pos][i]?
                        if key is array[pos][i][0]
                                array[pos][i].shift()
                                if array[pos][i].length is 1
                                        ret = array[pos][i][0]
                        else
                                array[pos][i].unshift(null)
                        i += 1
        else
                document.getElementById('input').style.color = "red"

        return ret

getKeyCode = ->
        code = event.keyCode
        code += 32
        if code is 221
                code = 45
        document.getElementById("input").innerHTML = String.fromCharCode(code)
        return String.fromCharCode(code)

startTyping = ->
        pos = 0
        inputed = ""
        array = prepareTyping("ちゃんちゃんちゃっちゃくぁっかとーんとーん")
        document.getElementById('inputed').innerHTML = inputed + displaytype()
        document.getElementById('roman').innerHTML = displaytype()

typeSentence = ->
        k = getKeyCode()
        t = checkType(k)
        if document.getElementById('input').style.color is "black"
                inputed += k
        document.getElementById('inputed').innerHTML = inputed + displaytype()
        document.getElementById('roman').innerHTML = displaytype()
        if t?
                pos = t
        document.getElementById('roman').innerHTML = displaytype()
        if array[pos]?
        else
                startTyping()